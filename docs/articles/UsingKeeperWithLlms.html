<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using Keeper with Large Language Models • Keeper</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using Keeper with Large Language Models">
<meta property="og:description" content="Keeper">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">Keeper</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/UsingKeeperWithLlms.html">Using Keeper with Large Language Models</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link"><img src='https://ohdsi.github.io/Hades/images/hadesMini.png' width=80 height=17 style='vertical-align: top;'></a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using Keeper with Large Language Models</h1>
                        <h4 data-toc-skip class="author">Martijn
Schuemie</h4>
            
            <h4 data-toc-skip class="date">2024-05-29</h4>
      
      
      <div class="hidden name"><code>UsingKeeperWithLlms.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes how one could use Keeper to generate patient
summaries, and have them be reviewed by a large-language model
(LLM).</p>
</div>
<div class="section level2">
<h2 id="running-keeper">Running Keeper<a class="anchor" aria-label="anchor" href="#running-keeper"></a>
</h2>
<p>As an example, we’ll run Keeper on Eunomia. Eunomia is an OHDSI
package that contains a tiny simulated dataset in the Common Data Model
(CDM). It is mostly focused on NSAIDs and gastrointestinal (GI)
bleeding, so we’ll use GI bleed as our example outcome.</p>
<div class="section level3">
<h3 id="setting-up-eunomia">Setting up Eunomia<a class="anchor" aria-label="anchor" href="#setting-up-eunomia"></a>
</h3>
<p>First we must download and install Eunomia:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"Eunomia"</span><span class="op">)</span></span></code></pre></div>
<p>Next, we can obtain connection details to the Eunomia database.
(Note: this will download the database from the internet):</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OHDSI/Eunomia" class="external-link">Eunomia</a></span><span class="op">)</span></span>
<span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/getEunomiaConnectionDetails.html" class="external-link">getEunomiaConnectionDetails</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## attempting to download GiBleed</span></span></code></pre>
<pre><code><span><span class="co">## attempting to extract and load: /var/folders/d5/7zcm15t57p3_91m486y3qtw40000gn/T//Rtmpt15gpC/GiBleed_5.3.zip to: /var/folders/d5/7zcm15t57p3_91m486y3qtw40000gn/T//Rtmpt15gpC/GiBleed_5.3.sqlite</span></span></code></pre>
<p>We can have the default set of cohorts generated in Eunomia:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Eunomia/man/createCohorts.html" class="external-link">createCohorts</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Cohorts created in table main.cohort</span></span></code></pre>
<pre><code><span><span class="co">##   cohortId       name</span></span>
<span><span class="co">## 1        1  Celecoxib</span></span>
<span><span class="co">## 2        2 Diclofenac</span></span>
<span><span class="co">## 3        3    GiBleed</span></span>
<span><span class="co">## 4        4     NSAIDs</span></span>
<span><span class="co">##                                                                                        description</span></span>
<span><span class="co">## 1    A simplified cohort definition for new users of celecoxib, designed specifically for Eunomia.</span></span>
<span><span class="co">## 2    A simplified cohort definition for new users ofdiclofenac, designed specifically for Eunomia.</span></span>
<span><span class="co">## 3 A simplified cohort definition for gastrointestinal bleeding, designed specifically for Eunomia.</span></span>
<span><span class="co">## 4       A simplified cohort definition for new users of NSAIDs, designed specifically for Eunomia.</span></span>
<span><span class="co">##   count</span></span>
<span><span class="co">## 1  1844</span></span>
<span><span class="co">## 2   850</span></span>
<span><span class="co">## 3   479</span></span>
<span><span class="co">## 4  2694</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="run-keeper">Run Keeper<a class="anchor" aria-label="anchor" href="#run-keeper"></a>
</h3>
<p>Next, we run Keeper. We meticulously select concepts for each Keeper
category:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keeper</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createKeeper.html">createKeeper</a></span><span class="op">(</span></span>
<span>    connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>    databaseId <span class="op">=</span> <span class="st">"Synpuf"</span>,</span>
<span>    cdmDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>    cohortDatabaseSchema <span class="op">=</span> <span class="st">"main"</span>,</span>
<span>    cohortTable <span class="op">=</span> <span class="st">"cohort"</span>,</span>
<span>    cohortDefinitionId <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    cohortName <span class="op">=</span> <span class="st">"GI Bleed"</span>,</span>
<span>    sampleSize <span class="op">=</span> <span class="fl">100</span>,</span>
<span>    assignNewId <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    useAncestor <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    doi <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4202064</span>, <span class="fl">192671</span>, <span class="fl">2108878</span>, <span class="fl">2108900</span>, <span class="fl">2002608</span><span class="op">)</span>,</span>
<span>    symptoms <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4103703</span>, <span class="fl">443530</span>, <span class="fl">4245614</span>, <span class="fl">28779</span><span class="op">)</span>,</span>
<span>    comorbidities <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">81893</span>, <span class="fl">201606</span>, <span class="fl">313217</span>, <span class="fl">318800</span>, <span class="fl">432585</span>, <span class="fl">4027663</span>, <span class="fl">4180790</span>, <span class="fl">4212540</span>,</span>
<span>                      <span class="fl">40481531</span>, <span class="fl">42535737</span>, <span class="fl">46271022</span><span class="op">)</span>, </span>
<span>    drugs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">904453</span>, <span class="fl">906780</span>, <span class="fl">923645</span>, <span class="fl">929887</span>, <span class="fl">948078</span>, <span class="fl">953076</span>, <span class="fl">961047</span>, <span class="fl">985247</span>, <span class="fl">992956</span>, </span>
<span>              <span class="fl">997276</span>, <span class="fl">1102917</span>, <span class="fl">1113648</span>, <span class="fl">1115008</span>, <span class="fl">1118045</span>, <span class="fl">1118084</span>, <span class="fl">1124300</span>, <span class="fl">1126128</span>, </span>
<span>              <span class="fl">1136980</span>, <span class="fl">1146810</span>, <span class="fl">1150345</span>, <span class="fl">1153928</span>, <span class="fl">1177480</span>, <span class="fl">1178663</span>, <span class="fl">1185922</span>, <span class="fl">1195492</span>, </span>
<span>              <span class="fl">1236607</span>, <span class="fl">1303425</span>, <span class="fl">1313200</span>, <span class="fl">1353766</span>, <span class="fl">1507835</span>, <span class="fl">1522957</span>, <span class="fl">1721543</span>, <span class="fl">1746940</span>, </span>
<span>              <span class="fl">1777806</span>, <span class="fl">19044727</span>, <span class="fl">19119253</span>, <span class="fl">36863425</span><span class="op">)</span>, </span>
<span>    diagnosticProcedures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4087381</span>, <span class="fl">4143985</span>, <span class="fl">4294382</span>, <span class="fl">42872565</span>, <span class="fl">45888171</span>, <span class="fl">46257627</span><span class="op">)</span>, </span>
<span>    measurements    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3000905</span>, <span class="fl">3000963</span>, <span class="fl">3003458</span>, <span class="fl">3012471</span>, <span class="fl">3016251</span>, <span class="fl">3018677</span>, <span class="fl">3020416</span>, </span>
<span>                     <span class="fl">3022217</span>, <span class="fl">3023314</span>, <span class="fl">3024929</span>, <span class="fl">3034426</span><span class="op">)</span>, </span>
<span>    alternativeDiagnosis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">24966</span>, <span class="fl">76725</span>, <span class="fl">195562</span>, <span class="fl">316457</span>, <span class="fl">318800</span>, <span class="fl">4096682</span><span class="op">)</span>, </span>
<span>    treatmentProcedures <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span>, </span>
<span>    complications <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">132797</span>, <span class="fl">196152</span>, <span class="fl">439777</span>, <span class="fl">4192647</span><span class="op">)</span>      </span>
<span>  <span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |=======================                                               |  33%  |                                                                              |===============================================                       |  67%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |=======================                                               |  33%  |                                                                              |===============================================                       |  67%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">## Getting cohort table.</span></span>
<span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |=======================                                               |  33%  |                                                                              |===============================================                       |  67%  |                                                                              |======================================================================| 100%</span></span>
<span><span class="co">## Getting patient data for keeperOutput.</span></span>
<span><span class="co">##   |                                                                              |                                                                      |   0%  |                                                                              |==                                                                    |   3%  |                                                                              |====                                                                  |   6%  |                                                                              |======                                                                |   9%  |                                                                              |========                                                              |  12%  |                                                                              |===========                                                           |  15%  |                                                                              |=============                                                         |  18%  |                                                                              |===============                                                       |  21%  |                                                                              |=================                                                     |  24%  |                                                                              |===================                                                   |  27%  |                                                                              |=====================                                                 |  30%  |                                                                              |=======================                                               |  33%  |                                                                              |=========================                                             |  36%  |                                                                              |============================                                          |  39%  |                                                                              |==============================                                        |  42%  |                                                                              |================================                                      |  45%  |                                                                              |==================================                                    |  48%  |                                                                              |====================================                                  |  52%  |                                                                              |======================================                                |  55%  |                                                                              |========================================                              |  58%  |                                                                              |==========================================                            |  61%  |                                                                              |=============================================                         |  64%  |                                                                              |===============================================                       |  67%  |                                                                              |=================================================                     |  70%  |                                                                              |===================================================                   |  73%  |                                                                              |=====================================================                 |  76%  |                                                                              |=======================================================               |  79%  |                                                                              |=========================================================             |  82%  |                                                                              |===========================================================           |  85%  |                                                                              |==============================================================        |  88%  |                                                                              |================================================================      |  91%  |                                                                              |==================================================================    |  94%  |                                                                              |====================================================================  |  97%  |                                                                              |======================================================================| 100%</span></span></code></pre>
<p>The output is a table with one row per person:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">keeper</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 100 × 18</span></span></span>
<span><span class="co">##    personId   age gender observationPeriod            visitContext  presentation</span></span>
<span><span class="co">##       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       </span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 1</span>       72    44 Male   -15931.0 days - 10060.0 days <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 2</span>       89    41 Female -15086.0 days - 13110.0 days <span style="color: #949494;">""</span>            Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 3</span>       78    44 Female -16007.0 days - 2998.0 days  <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 4</span>       79    40 Male   -14445.0 days - 12337.0 days <span style="color: #949494;">""</span>            Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 5</span>       64    35 Male   -12931.0 days - 6816.0 days  <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 6</span>       57    37 Female -13246.0 days - 16193.0 days <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 7</span>       51    38 Male   -13849.0 days - 12814.0 days <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 8</span>       17    35 Female -12933.0 days - 11238.0 days <span style="color: #949494;">""</span>            Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;"> 9</span>       28    36 Female -13213.0 days - 12830.0 days <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">10</span>       68    44 Male   -16313.0 days - 8551.0 days  <span style="color: #949494;">"</span>Inpatient V… Gastrointes…</span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 90 more rows</span></span></span>
<span><span class="co">## <span style="color: #949494;"># ℹ 12 more variables: comorbidities &lt;chr&gt;, symptoms &lt;chr&gt;, priorDisease &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   priorDrugs &lt;chr&gt;, priorTreatmentProcedures &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   diagnosticProcedures &lt;chr&gt;, measurements &lt;chr&gt;, alternativeDiagnosis &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   afterDisease &lt;chr&gt;, afterTreatmentProcedures &lt;chr&gt;, afterDrugs &lt;chr&gt;,</span></span></span>
<span><span class="co">## <span style="color: #949494;">#   death &lt;chr&gt;</span></span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="llm-review">LLM review<a class="anchor" aria-label="anchor" href="#llm-review"></a>
</h2>
<p>We can convert the Keeper output to prompts for a LLM, and parse the
output of the LLM to get a classification of whether the patient truly
had GI bleeding.</p>
<div class="section level3">
<h3 id="generating-prompts">Generating prompts<a class="anchor" aria-label="anchor" href="#generating-prompts"></a>
</h3>
<p>We need two prompts: the system prompt is a general description of
how the LLM should behave. The (main) prompt contains the
patient-specific information. First we create settings, then we generate
the system prompt:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use the default settings:</span></span>
<span><span class="va">settings</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createPromptSettings.html">createPromptSettings</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">systempPrompt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createSystemPrompt.html">createSystemPrompt</a></span><span class="op">(</span>setting <span class="op">=</span> <span class="va">settings</span>, </span>
<span>                                    diseaseName <span class="op">=</span> <span class="st">"Gastrointestinal bleeding"</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">systempPrompt</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Act as a medical doctor reviewing a patient's healthcare data captured during routine clinical care, such as electronic health records and insurance claims.</span></span>
<span><span class="co">## Write a medical narrative that fits the recorded health data followed by a determination of whether the patient had Gastrointestinal bleeding.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Remember that recording a diagnosis for a disease could occur either because the patient had the disease or as justification for performing a diagnostic procedure to determine whether the patient has the disease. A diagnosis by itself or accompanied with only diagnostic procedures may therefore be insufficient evidence, even if recorded more than once. Lack of additional evidence of Gastrointestinal bleeding other than the diagnosis and diagnostic procedures probably means that the patient was only being tested, and does not actually have Gastrointestinal bleeding. However, it unlikely that a patient will be tested many times over, so an abundance of diagnoses will mean the patient has the disease.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## In your final summary, indicate "yes" if the most probable scenario is that the patient had Gastrointestinal bleeding.</span></span>
<span><span class="co">## Indicate "no" if it is not the most probable scenario, for example when it is more likely that the patient was tested for the disease but the diagnosis was not confirmed. Also indicate "no" when there is insufficient information to say anything about the relative probability of scenarios.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Use the following format:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Clinical narrative:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Evidence in favor of Gastrointestinal bleeding:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Evidence against Gastrointestinal bleeding:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Summary: (Only "yes" or "no")</span></span></code></pre>
<p>Then, for each patient we can generate the main prompt:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">row</span> <span class="op">&lt;-</span> <span class="va">keeper</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span><span class="va">prompt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createPrompt.html">createPrompt</a></span><span class="op">(</span>setting <span class="op">=</span> <span class="va">settings</span>, </span>
<span>                       diseaseName <span class="op">=</span> <span class="st">"Gastrointestinal bleeding"</span>,</span>
<span>                       keeperRow <span class="op">=</span> <span class="va">row</span><span class="op">)</span>  </span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">prompt</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Demographics and details about the visit: Male, forty-four yo; Visit: Inpatient Visit (1.0 days)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diagnoses recorded on the day of the visit: Gastrointestinal hemorrhage;</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diagnoses recorded prior to the visit: Peptic ulcer (day -3521); Ulcerative colitis (day -636)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Treatments recorded prior to the visit: celecoxib (day -66.0, for 0.0 days);</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diagnostic procedures recorded proximal to the visit: None</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Laboratory tests recorded proximal to the visit: None</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Alternative diagnoses recorded proximal to the visit: None</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Diagnoses recorded after the visit: None</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Treatments recorded during or after the visit: Naproxen (day 4874.0, for 1440.0 days);</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="generate-a-response">Generate a response<a class="anchor" aria-label="anchor" href="#generate-a-response"></a>
</h3>
<p>Next, we can use the system prompt and prompt together to query the
LLM. Many LLMs are available, including open source ones. Setting up and
interacting with the LLM is beyond the scope of this vignette. Here we
assume a LLM was used to generate this response:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"Summary: yes"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parse-the-response">Parse the response<a class="anchor" aria-label="anchor" href="#parse-the-response"></a>
</h3>
<p>LLMs can be quite verbose, and often we just want a yes or no answer.
For this we can use the <code><a href="../reference/parseLlmResponse.html">parseLlmResponse()</a></code> function that
uses a set of patterns to decide between ‘yes’, ‘no’, or ‘I don’t
know’:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/parseLlmResponse.html">parseLlmResponse</a></span><span class="op">(</span><span class="va">response</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "yes"</span></span></code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Ostropolets Anna, Schuemie Martjn.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
